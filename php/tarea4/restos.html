<!DOCTYPE html>
<html>
<head>
	<title>Tarea4-SQLite</title>
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body>

</body>
</html>
<?php

// Set default timezone
date_default_timezone_set('UTC');

try {
/**************************************
* Create databases and                *
* open connections                    *
**************************************/

// Create (connect to) SQLite database in file
$file_db = new PDO('sqlite:clientes.db');
// Set errormode to exceptions
$file_db->setAttribute(PDO::ATTR_ERRMODE, 
	PDO::ERRMODE_EXCEPTION);


/**************************************
* Create tables                       *
**************************************/
// Create table clientes
//$file_db->exec("sqlite:clientes.db");

// Create table facturas
$file_db->exec("CREATE TABLE IF NOT EXISTS facturas (
	factura_num INTEGER, 
	fecha TEXT, 
	cliente TEXT,
	impuestos TEXT,
	montoTotal TEXT);");
// Create table productos
$file_db->exec("CREATE TABLE IF NOT EXISTS productos (
	factura_num INTEGER PRIMARY KEY, 
	cantidad TEXT, 
	descripcion TEXT,
	valUnit TEXT,
	subTotal TEXT);");


/**************************************
* Play with databases and tables      *
**************************************/

// Prepare INSERT statement to SQLite3 memory db
/*$insert = "INSERT INTO facturas (factura_num, fecha, cliente, impuestos, montoTotal) 
VALUES (:factura_num, :fecha, :cliente, :impuestos, :montoTotal)";
$stmt = $file_db->prepare($insert);
//********* Insert book 

// Bind parameters to statement variables
$stmt->bindParam(':factura_num', $factura_num);
$stmt->bindParam(':fecha', $fecha);
$stmt->bindParam(':cliente', $cliente);
$stmt->bindParam(':impuestos', $impuestos);
$stmt->bindParam(':montoTotal', $montoTotal);

// Set values to bound variables
$factura_num = 3455941;
$fecha = '25/03/2018';
$cliente = 'Gonzalo Mora';
$impuestos = '471.90';
$montoTotal = '2000';

// Execute statement
$stmt->execute();
*/ //inserts de facturas

/* // inserts de productos
// Prepare INSERT statement to SQLite3 memory db
$insert = "INSERT INTO productos (factura_num, cantidad, descripcion, valUnit, subTotal) 
VALUES (:factura_num, :fecha, :cliente, :impuestos, :montoTotal)";
$stmt = $file_db->prepare($insert);
//********* Insert book 

// Bind parameters to statement variables
$stmt->bindParam(':factura_num', $factura_num);
$stmt->bindParam(':cantidad', $cantidad);
$stmt->bindParam(':descripcion', $descripcion);
$stmt->bindParam(':valUnit', $valUnit);
$stmt->bindParam(':subTotal', $subTotal);

// Set values to bound variables
$factura_num = 3455941;
$cantidad = '1';
$descripcion = 'Caja de leche';
$valUnit = '2000';
$subTotal = '2000';

// Execute statement
$stmt->execute();
*/

// Select all data from file db messages table 
$result = $file_db->query('SELECT * FROM facturas');
//print $result['factura_num']."<br>";
$str='';
$str="<form method='get' action='index.php'><table><thead><tr>
      <th>Factura_num</th><th>Fecha</th><th>Cliente</th><th>Impuestos</th><th>MontoTotal</th><th>Acci贸n</th>
      </tr></thead><tbody>";
foreach($result as $row) {
	$str.= "<td>". $row['factura_num'] ."</td>";
	$str.= "<td>". $row['fecha'] ."</td>";
	$str.= "<td>". $row['cliente'] ."</td>";
	$str.= "<td>". $row['impuestos'] ."</td>";
	$str.= "<td>". $row['montoTotal'] ."</td>";
	$str.= "<td>
<button type='submit' name='buscar' value='". $row['factura_num'] ."'>Buscar</button></td>";
}
$str.="</tbody></table>";
$str.="<br><button type='submit' name='nuevo' value='1'>Nuevo</button>";
$str.="</form>";
echo $str;

/*$update2 = "UPDATE facturas SET montoTotal = '2000' WHERE factura_num = 3455941";
$stmt = $file_db->prepare($update2);
$stmt->execute();*/

echo "<br><h3>Facturaci贸n</h2>";

if (isset($_GET['buscar'])) {
	print"Factura_num ".$_GET['buscar'];

	// Select all data from file db messages table 
	$result = $file_db->query("SELECT * FROM productos WHERE factura_num='".$_GET['buscar']."'");

	//print $result['factura_num']."<br>";
	/*$str='';
	$str="<form method='get' action='index.php'><table><thead><tr>
	      <th>Factura_num</th><th>Fecha</th><th>Cliente</th><th>Impuestos</th><th>MontoTotal</th><th>Acci贸n</th>
	      </tr></thead><tbody>";
	foreach($result as $row) {
		$str.= "<td>". $row['factura_num'] ."</td>";
		$str.= "<td>". $row['cantidad'] ."</td>";
		$str.= "<td>". $row['descripcion'] ."</td>";
		$str.= "<td>". $row['valUnit'] ."</td>";
		$str.= "<td>". $row['subTotal'] ."</td>";
		$str.= "<td>
	<button type='submit' name='eliminar' value='". $row['factura_num'] ."'>Eliminar</button></td>";
	}
	//$str.= "<td></td>";
	$str.='<tr><form method="post">
                <td><input type="text" required name="txt_dia"></td>
                <td><input type="text" required name="txt_hora"></td>
                <td><input type="text" required name="txt_evento"></td>
                <td><input type="submit" name="agregar" value="Agregar"></td>
            </form></tr>';
	$str.= "<td><button type='submit' name='agregar' value='2'>Agregar</button></td>";
	$str.="</tbody></table>";
	//$str.="<br><button type='submit' name='agregar' value='2'>Agregar</button>";
	$str.="</form>";
	echo $str;*/
}
// seccion de buscar
// num input fecha input deshabilitado en caso de buscar
// cliente input 

// tabla de productos de la compra tal
//// cant 	descrip 		valUnit subTotal  accion
//// 1		cajas de leche	2000	2000	  eliminar  -> value=pos (unset pos del array)  
/// eliminar
/// 
// agregar para nuevos productos en array
//// $array-productos (cant->1, descrip->cepillos de dientes, valUnit->2000, subTotal->2000)
////
// cancelar / Taxes: 471.90 Total: 4701.90 / Guardar factura


// seccion de nuevo
// establecer arrays a []
// if isset de cada cosa valida que la tabla no salga 2 veces gracias al form bien definido
// num input fecha-predefinida / inputs habilitados en caso de nuevo
// cliente input 

// tabla de productos vacia de nueva compra
// agregar para nuevos productos
// cancelar / Taxes: 471.90 Total: 4701.90 / Guardar factura


// Select all data from file db messages table 
$result = $file_db->query('SELECT * FROM productos');
$str='';
$str="Factura_num: 123 <br><br>";
$str.="<form method='get' action='index.php'><table><thead><tr>
      <th>Cantidad</th><th>Descripcion</th><th>ValUnit</th><th>SubTotal</th><th>Acci贸n</th>
      </tr></thead><tbody>";
foreach($result as $row) {
	$str.= "<td>". $row['cantidad'] ."</td>";
	$str.= "<td>". $row['descripcion'] ."</td>";
	$str.= "<td>". $row['valUnit'] ."</td>";
	$str.= "<td>". $row['subTotal'] ."</td>";
	$str.= "<td>". $row['subTotal'] ."</td>";
	$str.= "<td>
<button type='submit' name='buscar' value='". $row['factura_num'] ."'>Eliminar</button></td>";
}
$str.="<td><input type='text' name='txt_cant'></td>";
$str.="<td><input style='width:8em;' type='text' name='txt_descrip'></td>";
$str.="<td><input type='text' name='txt_valUnit'></td>";
$str.="<td><input type='text' name='txt_subTotal'></td>";
$str.="<td><button type='submit' name='agregar' value=''>Agregar</button></td>";
$str.="</tbody></table>";
$str.="Taxes: 471.90  Total: 4701.90"; 
// para obtener taxes una fun obt_taxes($array_productos)

$str.="<br><button type='submit' name='nuevo' value='1'>Cancelar</button>";
$str.="<button type='submit' name='nuevo' value='1'>Guardar</button>";
$str.="</form>";
echo $str;


/**************************************
* Drop tables                         *
**************************************/

// Drop table messages from file db
//$file_db->exec("DROP TABLE books");
//$file_db->exec("DROP TABLE authors");
// Drop table messages from memory db
//$memory_db->exec("DROP TABLE messages");


/**************************************
* Close db connections                *
**************************************/

// Close file db connection
$file_db = null;
// Close memory db connection
$memory_db = null;
}
catch(PDOException $e) {
// Print PDOException message
	echo $e->getMessage();
}


?>
